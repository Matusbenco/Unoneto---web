<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
<script src="coi-serviceworker.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A/V CONVERTER | Office Tools</title>
    
    <script src="coi-serviceworker.js"></script>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7/download.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #ea580c; /* Oran≈æov√° pre konvertor */
            --primary-hover: #c2410c;
            --secondary: #0f172a;
            --bg-app: #f8fafc;
            --text-main: #1e293b;
            --border-radius: 12px;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); overflow-x: hidden; }
        * { box-sizing: border-box; }

        /* --- OCHRANA --- */
        #lockOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a; z-index: 9999999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: opacity 0.5s ease;
        }
        .lock-box {
            background: #1e293b; padding: 40px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center;
            max-width: 450px; width: 90%; border: 1px solid #334155;
        }
        .lock-input {
            padding: 15px; width: 100%; margin: 20px 0; border-radius: 10px;
            border: 1px solid #475569; background: #0f172a; color: white;
            font-size: 1.1rem; text-align: center; letter-spacing: 2px;
            font-family: monospace; outline: none;
        }
        .lock-input:focus { border-color: var(--primary); }
        .lock-btn {
            padding: 15px 30px; background: var(--primary); color: white;
            border: none; border-radius: 10px; font-weight: bold; cursor: pointer;
            font-size: 1rem; width: 100%; transition: 0.2s;
        }
        .lock-btn:hover { background: var(--primary-hover); transform: scale(1.02); }

        /* --- APP UI --- */
        header {
            background: white; padding: 15px 5%; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 1.4rem; color: var(--secondary); display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--primary); }
        .back-btn { text-decoration: none; color: #64748b; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .back-btn:hover { color: var(--primary); }

        .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }

        .drop-area {
            border: 3px dashed #cbd5e1; border-radius: 20px; background: white;
            padding: 40px 20px; text-align: center; cursor: pointer; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        .drop-area:hover, .drop-area.dragover { border-color: var(--primary); background: #fff7ed; transform: scale(1.01); }
        .drop-icon { font-size: 3.5rem; color: #cbd5e1; }
        
        /* SETTINGS & LIST */
        .work-area {
            background: white; border-radius: 16px; padding: 30px; margin-top: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
            display: none; animation: slideUp 0.4s ease;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .file-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 25px; }
        .file-item {
            display: flex; align-items: center; gap: 15px; padding: 12px; 
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;
        }
        .f-icon { font-size: 1.5rem; }
        .f-name { font-weight: 600; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .f-size { font-size: 0.8rem; color: #64748b; }
        .f-status { font-size: 0.8rem; font-weight: 700; color: #cbd5e1; }
        .f-status.done { color: #10b981; }
        .f-status.work { color: var(--primary); }

        .format-select-group {
            margin-bottom: 25px; padding: 20px; background: #fff7ed; 
            border: 1px solid #fed7aa; border-radius: 12px;
        }
        .main-select {
            width: 100%; padding: 12px; border: 2px solid #fdba74; border-radius: 8px;
            font-size: 1rem; background: white; cursor: pointer; font-weight: 600;
        }
        .main-select:focus { outline: none; border-color: var(--primary); }

        .action-btn {
            background: var(--primary); color: white; border: none; padding: 15px 30px;
            font-size: 1.1rem; font-weight: 700; border-radius: 50px; cursor: pointer;
            width: 100%; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .action-btn:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 10px 20px rgba(234, 88, 12, 0.3); }
        .action-btn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }

        /* CONSOLE LOG */
        #logArea {
            margin-top: 20px; background: #1e293b; color: #a5b4fc; 
            padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.8rem;
            max-height: 150px; overflow-y: auto; display: none;
        }

    </style>
</head>
<body>

   

    <header>
        <div class="brand">
            <div style="width:35px; height:35px; background:var(--primary); border-radius:8px; display:flex; align-items:center; justify-content:center; color:white; font-size:1.2rem;">üé¨</div>
            <div>A/V <span>CONVERTER</span></div>
        </div>
        <a href="index.html" class="back-btn">‚¨Ö Sp√§≈• na Dashboard</a>
    </header>

    <div class="container">
        
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="font-size: 2.2rem; font-weight: 800; margin-bottom: 10px; color: var(--secondary);">Konvertor Audia a Videa</h1>
            <p style="color: #64748b; font-size: 1rem;">
                Univerz√°lny n√°stroj. Preveƒète MOV na MP4, extrahujte hudbu z videa (MP4 na MP3)<br>
                alebo zme≈àte form√°t nahr√°vky (WAV na MP3).
            </p>
        </div>

        <div class="drop-area" id="dropArea">
            <div class="drop-icon">üìÇ</div>
            <div style="font-weight: 600; font-size: 1.1rem; color: #334155;">Nahrajte s√∫bory</div>
            <div style="color: #94a3b8; font-size: 0.9rem;">(Audio alebo Video s√∫bory)</div>
            <input type="file" id="fileInput" multiple accept="video/*, audio/*" style="display:none">
        </div>

        <div class="work-area" id="workArea">
            
            <div class="format-select-group">
                <label style="display:block; font-weight:700; margin-bottom:10px; color:#c2410c;">Konvertova≈• v≈°etko na:</label>
                <select id="selFormat" class="main-select">
                    <optgroup label="Video Form√°ty">
                        <option value="mp4">MP4 (Najlep≈°ie pre web/PC)</option>
                        <option value="avi">AVI (Star≈°√≠ ≈°tandard)</option>
                        <option value="mkv">MKV (Vysok√° kvalita)</option>
                        <option value="webm">WEBM (Google Video)</option>
                        <option value="mov">MOV (Apple)</option>
                    </optgroup>
                    <optgroup label="Audio Form√°ty (Extrakcia zvuku)">
                        <option value="mp3">MP3 (Najpou≈æ√≠vanej≈°ie)</option>
                        <option value="wav">WAV (Bez straty kvality)</option>
                        <option value="flac">FLAC (Lossless)</option>
                        <option value="aac">AAC (Apple Audio)</option>
                        <option value="ogg">OGG (Open format)</option>
                    </optgroup>
                </select>
            </div>

            <div class="file-list" id="fileList"></div>

            <button class="action-btn" id="btnConvert" onclick="startConversion()">
                <span>‚ö° Spusti≈• Konverziu</span>
            </button>

            <div id="logArea"></div>
        </div>

    </div>

<script>


    // --- 2. FFmpeg SETUP ---
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true, corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js' });
    let isFfmpegReady = false;

    // --- 3. UI LOGIKA ---
    let filesQueue = [];
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const workArea = document.getElementById('workArea');
    const fileList = document.getElementById('fileList');
    const logArea = document.getElementById('logArea');

    dropArea.addEventListener('click', () => fileInput.click());
    dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('dragover'); });
    dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
    dropArea.addEventListener('drop', (e) => { 
        e.preventDefault(); dropArea.classList.remove('dragover'); 
        handleFiles(e.dataTransfer.files); 
    });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    function handleFiles(files) {
        if(files.length === 0) return;
        
        // Load FFmpeg on first upload
        if(!isFfmpegReady) { 
            log("Naƒç√≠tavam FFmpeg jadro...");
            ffmpeg.load().then(() => { 
                isFfmpegReady = true; 
                log("FFmpeg pripraven√Ω!"); 
            });
        }

        Array.from(files).forEach(f => {
            filesQueue.push({
                file: f,
                id: Math.random().toString(36).substr(2, 9),
                status: 'pending'
            });
        });
        
        renderList();
        workArea.style.display = 'block';
    }

    function renderList() {
        fileList.innerHTML = '';
        filesQueue.forEach((item) => {
            let icon = item.file.type.startsWith('video') ? 'üé¨' : 'üéµ';
            let statusText = 'ƒåak√°';
            let statusClass = 'f-status';

            if(item.status === 'processing') { statusText = 'Spracov√°vam...'; statusClass += ' work'; }
            if(item.status === 'done') { statusText = 'Hotovo ‚úÖ'; statusClass += ' done'; }

            fileList.innerHTML += `
                <div class="file-item">
                    <div class="f-icon">${icon}</div>
                    <div class="f-name">${item.file.name}</div>
                    <div class="f-size">${(item.file.size/1024/1024).toFixed(2)} MB</div>
                    <div class="${statusClass}" id="stat-${item.id}">${statusText}</div>
                    ${item.status === 'pending' ? `<button onclick="removeFile('${item.id}')" style="border:none;background:none;cursor:pointer;color:red;">‚úñ</button>` : ''}
                </div>
            `;
        });
    }

    window.removeFile = (id) => {
        filesQueue = filesQueue.filter(x => x.id !== id);
        renderList();
        if(filesQueue.length === 0) workArea.style.display = 'none';
    }

    function log(msg) {
        logArea.style.display = 'block';
        logArea.innerHTML += `> ${msg}<br>`;
        logArea.scrollTop = logArea.scrollHeight;
    }

    // --- 4. CONVERSION LOGIC ---
    async function startConversion() {
        if(!isFfmpegReady) { alert("FFmpeg sa e≈°te naƒç√≠tava, ƒçakajte..."); return; }
        
        const targetFormat = document.getElementById('selFormat').value;
        const btn = document.getElementById('btnConvert');
        
        btn.disabled = true;
        btn.innerHTML = "‚è≥ Pracujem...";

        for (let item of filesQueue) {
            if(item.status === 'done') continue; // Preskoƒçi≈• hotov√©

            item.status = 'processing';
            renderList();

            try {
                const fName = item.file.name;
                // Vyƒçisti≈• meno od medzier pre FFmpeg
                const safeName = "input_" + item.id + "_" + fName.replace(/\s/g, '_');
                const outputName = `output_${item.id}.${targetFormat}`;

                log(`Nahr√°vam ${fName} do pam√§te...`);
                ffmpeg.FS('writeFile', safeName, await fetchFile(item.file));

                log(`Konvertujem na ${targetFormat.toUpperCase()}...`);
                
                // Zostavenie pr√≠kazu
                // Z√°klad: -i input output
                let args = ['-i', safeName];

                // Optimaliz√°cia pre video (r√Ωchlos≈•)
                const isVideoOut = ['mp4','avi','mkv','webm','mov'].includes(targetFormat);
                const isAudioOut = ['mp3','wav','flac','aac','ogg'].includes(targetFormat);

                if (isVideoOut) {
                    // Pou≈æi≈• ultrafast preset pre x264
                    args.push('-preset', 'ultrafast');
                    // Ak je vstup video a v√Ωstup video, kodeky:
                    if (targetFormat === 'mp4') { args.push('-c:v', 'libx264', '-c:a', 'aac'); }
                    if (targetFormat === 'webm') { args.push('-c:v', 'libvpx-vp9', '-c:a', 'libopus'); }
                }

                if (isAudioOut) {
                    // Ak je vstup video a chceme audio, FFmpeg to sprav√≠ automaticky, ale m√¥≈æeme da≈• -vn (no video)
                    args.push('-vn'); 
                    // Kodeky
                    if (targetFormat === 'mp3') { args.push('-c:a', 'libmp3lame'); }
                }

                args.push(outputName);

                await ffmpeg.run(...args);

                log(`Hotovo. S≈•ahujem...`);
                const data = ffmpeg.FS('readFile', outputName);

                // Urƒçenie MIME
                let mime = 'application/octet-stream';
                if(targetFormat === 'mp4') mime = 'video/mp4';
                if(targetFormat === 'mp3') mime = 'audio/mpeg';
                if(targetFormat === 'wav') mime = 'audio/wav';

                download(new Blob([data.buffer], { type: mime }), fName.split('.')[0] + '.' + targetFormat, mime);

                // Cleanup
                ffmpeg.FS('unlink', safeName);
                ffmpeg.FS('unlink', outputName);

                item.status = 'done';
                renderList();

            } catch(e) {
                console.error(e);
                log(`CHYBA: ${e.message}`);
                item.status = 'error';
                renderList();
            }
        }

        btn.disabled = false;
        btn.innerHTML = "‚ö° Spusti≈• Konverziu";
    }

</script>
</body>
</html>