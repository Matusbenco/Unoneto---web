<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nahr√°vaƒç obrazovky | Pro Verzia</title>
    
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f4f4f9; text-align: center; color: #333; }
        
        .recorder-box {
            background: white; padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 20px;
        }

        video {
            width: 100%; max-height: 500px; background: #000; border-radius: 8px;
            margin: 20px 0; display: none;
        }

        .controls {
            display: flex; justify-content: center; gap: 15px; align-items: center; flex-wrap: wrap; margin-top: 20px;
        }

        select, button {
            padding: 12px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;
        }
        
        select { border: 2px solid #e2e8f0; background: #fff; color: #4a5568; }
        
        button { border: none; color: white; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        #btn-start { background-color: #3182ce; }
        #btn-start:disabled { background-color: #cbd5e0; cursor: not-allowed; }
        #btn-stop { background-color: #e53e3e; display: none; }

        .status { margin-top: 20px; font-weight: 500; color: #718096; min-height: 24px; }
        .error-log { color: #e53e3e; font-size: 0.9em; margin-top: 10px; display: none; white-space: pre-wrap; }

        .rec-dot {
            color: #e53e3e; font-weight: bold; animation: pulse 1.5s infinite; 
            display: none; margin-bottom: 10px; font-size: 1.2em;
        }

        /* Varovania pre mobil */
        .mobile-alert {
            background: #fff3cd; color: #856404; padding: 12px; border-radius: 8px; 
            margin-bottom: 20px; border: 1px solid #ffeeba; display: none; text-align: left; font-size: 0.9em;
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <h1>Nahr√°vaƒç obrazovky</h1>

   
    <div id="iosAlert" class="mobile-alert">
        üçé <b>iOS (iPhone/iPad):</b> Apple blokuje nahr√°vanie obrazovky cez webov√© prehliadaƒçe. Pros√≠m, pou≈æite vstavan√© nahr√°vanie v Ovl√°dacom centre iOS.
    </div>

    <div id="androidAlert" class="mobile-alert" style="background: #d4edda; color: #155724; border-color: #c3e6cb;">
        üì± <b>Re≈æim Android:</b> Bola aktivovan√° odƒæahƒçen√° verzia. Konverzia videa je vypnut√° pre stabilitu syst√©mu. Video sa ulo≈æ√≠ v origin√°lnom form√°te.
    </div>
    
    <div class="recorder-box">
        <div class="rec-dot" id="recDot">üî¥ NAHR√ÅVANIE BE≈Ω√ç...</div>
        
        <video id="preview" autoplay muted playsinline></video>

        <div class="controls">
            <select id="formatSelect">
                <option value="original">WebM (Origin√°l - R√Ωchle)</option>
                <option value="mp4" selected>MP4 (Pomal≈°ie - Konverzia)</option>
                <option value="avi">AVI</option>
                <option value="gif">GIF (Bez zvuku)</option>
            </select>

            <button id="btn-start">‚ñ∂ Spusti≈• nahr√°vanie</button>
            <button id="btn-stop">‚èπ Ukonƒçi≈•</button>
        </div>

        <div class="status" id="statusLog">Pripraven√©.</div>
        <div class="error-log" id="errorLog"></div>
    </div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    let ffmpeg = null;

    const preview = document.getElementById('preview');
    const btnStart = document.getElementById('btn-start');
    const btnStop = document.getElementById('btn-stop');
    const formatSelect = document.getElementById('formatSelect');
    const statusLog = document.getElementById('statusLog');
    const errorLog = document.getElementById('errorLog');

    // Detekcia zariadenia
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isAndroid = /Android/.test(navigator.userAgent);
    const isMobile = isIOS || isAndroid;

    // Kontrola HTTPS
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        document.getElementById('httpsAlert').style.display = 'block';
    }

    // Nastavenie UI podƒæa zariadenia
    if (isIOS) {
        document.getElementById('iosAlert').style.display = 'block';
        btnStart.disabled = true;
        statusLog.innerText = "Nepodporovan√© na iOS.";
    } 
    else if (isMobile) {
        document.getElementById('androidAlert').style.display = 'block';
        // Na mobile zak√°≈æeme n√°roƒçn√© form√°ty
        const options = formatSelect.options;
        for (let i = 0; i < options.length; i++) {
            if (options[i].value !== 'original') {
                options[i].disabled = true;
                options[i].text += " (Iba PC)";
            }
        }
        formatSelect.value = 'original'; // Vyn√∫time origin√°l
        statusLog.innerText = "Pripraven√© (Mobiln√Ω re≈æim).";
    }

    let mediaRecorder;
    let recordedChunks = [];
    let supportedMimeType = "";

    // 1. Zistenie najlep≈°ieho form√°tu
    function getSupportedMimeType() {
        const types = [
            "video/webm;codecs=vp9", 
            "video/webm;codecs=vp8", 
            "video/webm", 
            "video/mp4" // Niektor√© Androidy podporuj√∫ priamo MP4
        ];
        for (const type of types) {
            if (MediaRecorder.isTypeSupported(type)) return type;
        }
        return "";
    }

    // 2. Naƒç√≠tanie FFmpeg (IBA PRE PC)
    async function loadFFmpeg() {
        if (isMobile) return false; // Na mobile FFmpeg nikdy nesp√∫≈°≈•ame

        if (ffmpeg) return true;
        statusLog.innerText = "‚è≥ Naƒç√≠tavam konvertor...";
        try {
            ffmpeg = createFFmpeg({ corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js', log: true });
            await ffmpeg.load();
            statusLog.innerText = "‚úÖ Konvertor pripraven√Ω.";
            return true;
        } catch (e) {
            console.error(e);
            errorLog.style.display = 'block';
            errorLog.innerText = "Chyba konvertora: " + e.message;
            return false;
        }
    }

    btnStart.addEventListener('click', async () => {
        recordedChunks = [];
        errorLog.style.display = 'none';
        
        supportedMimeType = getSupportedMimeType();
        if (!supportedMimeType) {
            alert("Tvoj prehliadaƒç nepodporuje ≈æiadny zn√°my form√°t nahr√°vania.");
            return;
        }

        try {
            statusLog.innerText = "Vy≈æiadavam povolenie...";
            
            // Konfigur√°cia streamu - pre mobil opatrnej≈°ie
            const constraints = {
                video: isMobile ? true : { cursor: "always" }, 
                audio: true 
            };

            let stream;
            try {
                stream = await navigator.mediaDevices.getDisplayMedia(constraints);
            } catch (err) {
                // Ak zlyh√° audio (ƒçast√© na mobile), sk√∫sime to bez neho
                console.warn("Prv√Ω pokus zlyhal, sk√∫≈°am bez audia...", err);
                if (isMobile) {
                    stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
                } else {
                    throw err; // Na PC to nech√°me padn√∫≈• a vyp√≠≈°eme chybu
                }
            }

            preview.srcObject = stream;
            preview.style.display = 'block';
            btnStart.style.display = 'none';
            btnStop.style.display = 'flex';
            document.getElementById('recDot').style.display = 'block';
            
            if(!isMobile) formatSelect.disabled = true;
            statusLog.innerText = "Nahr√°vam...";

            mediaRecorder = new MediaRecorder(stream, { mimeType: supportedMimeType });

            mediaRecorder.ondataavailable = (e) => {
                if (e.data && e.data.size > 0) {
                    recordedChunks.push(e.data);
                }
            };

            mediaRecorder.onstop = processRecording;

            // Ukladanie po 1s blokoch pre bezpeƒçnos≈•
            mediaRecorder.start(1000); 

        } catch (err) {
            console.error(err);
            statusLog.innerText = "‚ùå Chyba pri ≈°tarte.";
            errorLog.style.display = 'block';
            errorLog.innerText = "Nepodarilo sa spusti≈• nahr√°vanie.\nDetail: " + err.message + "\n\nTip: Na mobile sk√∫s in√Ω prehliadaƒç (Chrome/Firefox).";
        }
    });

    btnStop.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            if(preview.srcObject) {
                preview.srcObject.getTracks().forEach(track => track.stop());
            }
        }
    });

    async function processRecording() {
        document.getElementById('recDot').style.display = 'none';
        btnStop.style.display = 'none';
        statusLog.innerText = "Spracov√°vam...";

        const originalBlob = new Blob(recordedChunks, { type: supportedMimeType });

        if (originalBlob.size === 0) {
            statusLog.innerText = "‚ùå Chyba: Nahralo sa 0 bajtov.";
            resetUI();
            return;
        }

        const format = formatSelect.value;

        // Ak je to mobil alebo pou≈æ√≠vateƒæ chce origin√°l -> s≈•ahujeme hneƒè
        // T√Ωmto sa vyhneme p√°du na mobile
        if (format === 'original' || isMobile) {
            let ext = 'webm';
            if (supportedMimeType.includes('mp4')) ext = 'mp4';
            
            downloadBlob(originalBlob, `nahravka.${ext}`);
            statusLog.innerText = "‚úÖ Ulo≈æen√© (Origin√°l)";
            resetUI();
            return;
        }

        // --- SEKCIA KONVERZIE (IBA PC) ---
        try {
            const isLoaded = await loadFFmpeg();
            if (!isLoaded) throw new Error("FFmpeg modul nie je dostupn√Ω");

            statusLog.innerText = `üîÑ Konvertujem na ${format.toUpperCase()}...`;
            
            ffmpeg.FS('writeFile', 'input.video', await fetchFile(originalBlob));

            let args = ['-i', 'input.video', `output.${format}`];
            if (format === 'mp4') {
                args = ['-i', 'input.video', '-c:v', 'libx264', '-preset', 'ultrafast', `output.mp4`];
            }
            if (format === 'gif') {
                args = ['-i', 'input.video', '-vf', 'fps=10,scale=480:-1', `output.gif`];
            }

            await ffmpeg.run(...args);

            const data = ffmpeg.FS('readFile', `output.${format}`);
            if (data.length === 0) throw new Error("Konverzia zlyhala (pr√°zdny s√∫bor)");

            const outputBlob = new Blob([data.buffer], { type: `video/${format}` });
            downloadBlob(outputBlob, `video.${format}`);
            statusLog.innerText = "‚úÖ Hotovo!";

            try { ffmpeg.FS('unlink', 'input.video'); ffmpeg.FS('unlink', `output.${format}`); } catch(e){}

        } catch (err) {
            console.error(err);
            errorLog.innerText = "Chyba konverzie (" + err.message + "). S≈•ahujem origin√°l.";
            errorLog.style.display = 'block';
            // Z√°chrana - stiahni aspo≈à origin√°l
            downloadBlob(originalBlob, 'zachrana-video.webm');
        }

        resetUI();
    }

    function downloadBlob(blob, name) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => window.URL.revokeObjectURL(url), 100);
    }

    function resetUI() {
        btnStart.style.display = 'flex';
        preview.style.display = 'none';
        
        if (!isMobile) formatSelect.disabled = false;
        
        // Vr√°time status na Pripraven√© po chv√≠ƒæke
        setTimeout(() => {
            if(statusLog.innerText.includes("Hotovo") || statusLog.innerText.includes("Ulo≈æen√©")) {
                statusLog.innerText = isMobile ? "Pripraven√© (Mobil)" : "Pripraven√©.";
            }
        }, 3000);
    }
</script>

</body>
</html>
