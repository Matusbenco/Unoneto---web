<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nahr√°vaƒç obrazovky | Mobile Fix</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f4f4f9; text-align: center; color: #333; }
        .recorder-box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 20px; }
        video { width: 100%; max-height: 500px; background: #000; border-radius: 8px; margin: 20px 0; display: none; }
        .controls { display: flex; justify-content: center; gap: 15px; align-items: center; flex-wrap: wrap; margin-top: 20px; }
        select, button { padding: 12px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        select { border: 2px solid #e2e8f0; background: #fff; color: #4a5568; }
        button { border: none; color: white; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        #btn-start { background-color: #3182ce; }
        #btn-stop { background-color: #e53e3e; display: none; }
        .status { margin-top: 20px; font-weight: 500; color: #718096; min-height: 24px; }
        .error-log { color: #e53e3e; font-size: 0.9em; margin-top: 10px; display: none; }
        .rec-dot { color: #e53e3e; font-weight: bold; animation: pulse 1.5s infinite; display: none; margin-bottom: 10px; font-size: 1.2em; }
        .mobile-warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; border: 1px solid #ffeeba; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <h1>Nahr√°vaƒç obrazovky</h1>
    
    <div id="iosWarning" class="mobile-warning">
        ‚ö†Ô∏è <b>Pozor:</b> Na zariadeniach iPhone/iPad Apple blokuje nahr√°vanie obrazovky cez web.
    </div>

    <div id="androidNote" class="mobile-warning">
        üì± <b>Re≈æim Android:</b> Konverzia na MP4 je vypnut√° kv√¥li v√Ωkonu. Video sa stiahne v origin√°lnom form√°te.
    </div>
    
    <div class="recorder-box">
        <div class="rec-dot" id="recDot">üî¥ NAHR√ÅVANIE BE≈Ω√ç...</div>
        <video id="preview" autoplay muted playsinline></video>

        <div class="controls">
            <select id="formatSelect">
                <option value="original">WebM (Origin√°l - Bezpeƒçn√©)</option>
                <option value="mp4" selected>MP4 (Konverzia)</option>
                <option value="avi">AVI</option>
                <option value="gif">GIF (Bez zvuku)</option>
            </select>

            <button id="btn-start">‚ñ∂ Spusti≈• nahr√°vanie</button>
            <button id="btn-stop">‚èπ Ukonƒçi≈•</button>
        </div>

        <div class="status" id="statusLog">Pripraven√©.</div>
        <div class="error-log" id="errorLog"></div>
    </div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    let ffmpeg = null;

    const preview = document.getElementById('preview');
    const btnStart = document.getElementById('btn-start');
    const btnStop = document.getElementById('btn-stop');
    const formatSelect = document.getElementById('formatSelect');
    const statusLog = document.getElementById('statusLog');
    const errorLog = document.getElementById('errorLog');
    const iosWarning = document.getElementById('iosWarning');
    const androidNote = document.getElementById('androidNote');

    let mediaRecorder;
    let recordedChunks = [];
    let supportedMimeType = "";

    // DETEKCIA MOBILU
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isAndroid = /Android/.test(navigator.userAgent);
    const isMobile = isIOS || isAndroid;

    // √öprava UI pre mobil
    if (isIOS) {
        iosWarning.style.display = 'block';
        btnStart.disabled = true; // Na iOS to nem√° zmysel ani sk√∫≈°a≈•
        btnStart.style.backgroundColor = '#cbd5e0';
        statusLog.innerText = "‚ùå iOS nepodporuje nahr√°vanie obrazovky cez web.";
    } else if (isAndroid) {
        androidNote.style.display = 'block';
        // Na Androide zak√°≈æeme konverziu (MP4/GIF), lebo to zhod√≠ prehliadaƒç
        formatSelect.value = "original";
        formatSelect.disabled = true;
        statusLog.innerText = "üì± Android detegovan√Ω: Konverzia vypnut√°.";
    }

    function getSupportedMimeType() {
        const types = [
            "video/webm;codecs=vp9", 
            "video/webm;codecs=vp8", 
            "video/webm", 
            "video/mp4" // Niektor√© Androidy podporuj√∫ priamo MP4 nahr√°vanie
        ];
        for (const type of types) {
            if (MediaRecorder.isTypeSupported(type)) {
                return type;
            }
        }
        return "";
    }

    async function loadFFmpeg() {
        if (isMobile) return false; // Na mobile FFmpeg nesp√∫≈°≈•ame
        if (ffmpeg) return true;
        
        statusLog.innerText = "‚è≥ Naƒç√≠tavam konvertor...";
        try {
            ffmpeg = createFFmpeg({ corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js', log: true });
            await ffmpeg.load();
            statusLog.innerText = "‚úÖ Konvertor pripraven√Ω.";
            return true;
        } catch (e) {
            console.error(e);
            errorLog.style.display = 'block';
            errorLog.innerText = "Chyba konvertora. Bude≈° s≈•ahova≈• len origin√°l.";
            return false;
        }
    }

    btnStart.addEventListener('click', async () => {
        if(isIOS) return;

        recordedChunks = [];
        errorLog.style.display = 'none';
        
        supportedMimeType = getSupportedMimeType();
        if (!supportedMimeType) {
            alert("Tvoj prehliadaƒç nepodporuje nahr√°vanie.");
            return;
        }

        try {
            // Na mobile parameter { cursor: "always" } m√¥≈æe robi≈• probl√©my, odstr√°nime ho
            const displayMediaOptions = {
                video: true,
                audio: true
            };

            const stream = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);

            preview.srcObject = stream;
            preview.style.display = 'block';
            btnStart.style.display = 'none';
            btnStop.style.display = 'flex';
            document.getElementById('recDot').style.display = 'block';
            formatSelect.disabled = true;
            statusLog.innerText = "Nahr√°vam...";

            mediaRecorder = new MediaRecorder(stream, { mimeType: supportedMimeType });

            mediaRecorder.ondataavailable = (e) => {
                if (e.data && e.data.size > 0) {
                    recordedChunks.push(e.data);
                }
            };

            mediaRecorder.onstop = processRecording;
            mediaRecorder.start(1000); 

        } catch (err) {
            console.error(err);
            statusLog.innerText = "‚ùå Nahr√°vanie zru≈°en√© alebo nepodporovan√©.";
        }
    });

    btnStop.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            if(preview.srcObject) {
                preview.srcObject.getTracks().forEach(track => track.stop());
            }
        }
    });

    async function processRecording() {
        document.getElementById('recDot').style.display = 'none';
        btnStop.style.display = 'none';
        statusLog.innerText = "Spracov√°vam...";

        const originalBlob = new Blob(recordedChunks, { type: supportedMimeType });

        if (originalBlob.size === 0) {
            statusLog.innerText = "‚ùå Chyba: Nahralo sa 0 bajtov.";
            resetUI();
            return;
        }

        const format = formatSelect.value;

        // Ak je to mobil alebo pou≈æ√≠vateƒæ chce origin√°l -> s≈•ahujeme hneƒè
        if (format === 'original' || isMobile) {
            // Prid√°me pr√≠ponu podƒæa MIME typu
            let ext = 'webm';
            if (supportedMimeType.includes('mp4')) ext = 'mp4';
            
            downloadBlob(originalBlob, `nahravka.${ext}`);
            resetUI();
            return;
        }

        // ... ZVY≈†OK K√ìDU PRE KONVERZIU NA DESKTOPE OST√ÅVA ROVNAK√ù ...
        try {
            const isLoaded = await loadFFmpeg();
            if (!isLoaded) throw new Error("FFmpeg sa nenaƒç√≠tal");

            statusLog.innerText = `üîÑ Konvertujem na ${format.toUpperCase()}...`;
            
            ffmpeg.FS('writeFile', 'input.video', await fetchFile(originalBlob));

            let args = ['-i', 'input.video', `output.${format}`];
            if (format === 'mp4') {
                args = ['-i', 'input.video', '-c:v', 'libx264', '-preset', 'ultrafast', `output.mp4`];
            }
            if (format === 'gif') {
                args = ['-i', 'input.video', '-vf', 'fps=10,scale=480:-1', `output.gif`];
            }

            await ffmpeg.run(...args);

            const data = ffmpeg.FS('readFile', `output.${format}`);
            if (data.length === 0) throw new Error("Chyba konverzie");

            const outputBlob = new Blob([data.buffer], { type: `video/${format}` });
            downloadBlob(outputBlob, `video.${format}`);
            statusLog.innerText = "‚úÖ Hotovo!";

            try { ffmpeg.FS('unlink', 'input.video'); ffmpeg.FS('unlink', `output.${format}`); } catch(e){}

        } catch (err) {
            console.error(err);
            errorLog.innerText = "Konverzia zlyhala. S≈•ahujem origin√°l.";
            errorLog.style.display = 'block';
            downloadBlob(originalBlob, 'zachrana-video.webm');
        }

        resetUI();
    }

    function downloadBlob(blob, name) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => window.URL.revokeObjectURL(url), 100);
    }

    function resetUI() {
        btnStart.style.display = 'flex';
        preview.style.display = 'none';
        
        // Ak je mobil, nechaj select zablokovan√Ω
        if (!isMobile) {
            formatSelect.disabled = false;
        }
        statusLog.innerText = isMobile ? "Pripraven√© (Re≈æim Mobil)" : "Pripraven√©.";
    }
</script>

</body>
</html>