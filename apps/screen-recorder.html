<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Recorder Studio | Unoneto</title>
    
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .btn-gradient {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            transition: all 0.3s;
        }
        .btn-gradient:hover {
            filter: brightness(1.1); transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px rgba(220, 38, 38, 0.5);
        }
        
        .toggle-btn {
            background: #1e293b; border: 1px solid #334155; color: #94a3b8;
            padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
        }
        .toggle-btn.active {
            background: rgba(16, 185, 129, 0.15); border-color: #10b981; color: #10b981;
        }

        video { width: 100%; border-radius: 12px; background: #000; max-height: 60vh; }
        
        .rec-indicator {
            width: 12px; height: 12px; background: #ef4444; border-radius: 50%;
            display: inline-block; margin-right: 8px; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="h-20 border-b border-slate-700 flex items-center justify-between px-6 lg:px-10 shrink-0 bg-slate-900/90 backdrop-blur z-50">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-red-500 to-rose-600 flex items-center justify-center text-white text-xl shadow-lg shadow-red-500/20">
                <i class="fa-solid fa-video"></i>
            </div>
            <div>
                <h1 class="font-outfit font-bold text-xl tracking-tight text-white">Screen Recorder <span class="text-red-500">Studio</span></h1>
                <p class="text-xs text-slate-400">Video & Audio Mixer</p>
            </div>
        </div>
        <a href="index.html" class="text-slate-400 hover:text-white transition font-medium flex items-center gap-2 text-sm bg-slate-800 px-4 py-2 rounded-lg border border-slate-700 hover:border-slate-500">
            <i class="fa-solid fa-arrow-left"></i> Sp√§≈•
        </a>
    </header>

    <main class="flex-1 w-full max-w-6xl mx-auto p-6 flex flex-col gap-6">

        <div class="glass-panel p-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                
                <div class="flex flex-wrap gap-3 justify-center">
                    <button class="toggle-btn" id="btnMic" onclick="toggleAudio('mic')">
                        <i class="fa-solid fa-microphone"></i> Mikrof√≥n
                    </button>
                    <button class="toggle-btn" id="btnSys" onclick="toggleAudio('sys')">
                        <i class="fa-solid fa-volume-high"></i> Zvuk PC
                    </button>
                </div>

                <div class="flex items-center gap-3">
                    <label class="text-slate-400 text-sm font-bold">Form√°t:</label>
                    <select id="formatSelect" class="bg-slate-900 border border-slate-700 text-white text-sm rounded-lg p-2.5 outline-none focus:border-red-500">
                        <option value="webm">WebM (Origin√°l - R√Ωchle)</option>
                        <option value="mp4" selected>MP4 (Kompatibiln√©)</option>
                        <option value="gif">GIF (Bez zvuku)</option>
                    </select>
                </div>

                <div class="flex gap-3">
                    <button id="btnStart" class="btn-gradient text-white px-8 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-red-600/20" onclick="startRecording()">
                        <i class="fa-solid fa-circle"></i> Nahr√°va≈•
                    </button>
                    <button id="btnStop" class="bg-slate-700 hover:bg-slate-600 text-white px-8 py-3 rounded-xl font-bold hidden items-center gap-2 border border-slate-600" onclick="stopRecording()">
                        <i class="fa-solid fa-stop"></i> Ukonƒçi≈•
                    </button>
                </div>
            </div>

            <div id="audioHint" class="hidden mt-4 p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg text-yellow-200 text-sm text-center">
                <i class="fa-solid fa-circle-exclamation mr-2"></i>
                <b>D√¥le≈æit√©:</b> V okne, ktor√© vyskoƒç√≠, mus√≠te za≈°krtn√∫≈• <b>"Zdieƒæa≈• zvuk syst√©mu"</b> (Share system audio), inak bude video bez zvuku PC.
            </div>
        </div>

        <div class="glass-panel p-2 relative min-h-[400px] flex items-center justify-center bg-black/40">
            
            <div id="placeholder" class="text-center text-slate-500">
                <i class="fa-solid fa-desktop text-6xl mb-4 opacity-50"></i>
                <p>N√°hƒæad obrazovky sa objav√≠ tu</p>
            </div>

            <video id="previewVideo" autoplay muted playsinline class="hidden"></video>

            <div id="recStatus" class="absolute top-6 left-6 bg-red-500/90 backdrop-blur text-white px-4 py-2 rounded-full text-xs font-bold items-center gap-2 hidden shadow-lg animate-pulse">
                <div class="w-2 h-2 bg-white rounded-full"></div>
                NAHR√ÅVAM... <span id="timer">00:00</span>
            </div>
        </div>

        <div class="text-center">
            <div id="statusLog" class="text-slate-400 text-sm font-mono h-6">Pripraven√© na nahr√°vanie.</div>
            <div id="errorLog" class="text-red-400 text-sm font-mono mt-2 hidden"></div>
        </div>

    </main>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    let ffmpeg = null;
    let mediaRecorder;
    let recordedChunks = [];
    let stream = null;
    let micStream = null;
    let audioContext = null;
    let mixedDest = null;
    let timerInterval;
    let startTime;

    // Settings State
    let state = {
        mic: false,
        sys: false
    };

    // UI Elements
    const btnMic = document.getElementById('btnMic');
    const btnSys = document.getElementById('btnSys');
    const audioHint = document.getElementById('audioHint');
    const previewVideo = document.getElementById('previewVideo');
    const placeholder = document.getElementById('placeholder');
    const recStatus = document.getElementById('recStatus');
    const timerDisplay = document.getElementById('timer');
    const statusLog = document.getElementById('statusLog');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');

    // --- 1. UI LOGIKA ---
    
    function toggleAudio(type) {
        state[type] = !state[type];
        
        // Update UI classes
        if (type === 'mic') btnMic.classList.toggle('active');
        if (type === 'sys') {
            btnSys.classList.toggle('active');
            // Show hint only if system audio is requested
            if(state.sys) audioHint.classList.remove('hidden');
            else audioHint.classList.add('hidden');
        }
    }

    function updateTimer() {
        const diff = Math.floor((Date.now() - startTime) / 1000);
        const m = Math.floor(diff / 60).toString().padStart(2, '0');
        const s = (diff % 60).toString().padStart(2, '0');
        timerDisplay.innerText = `${m}:${s}`;
    }

    // --- 2. RECORDING LOGIC (THE HARD PART) ---

    async function startRecording() {
        recordedChunks = [];
        document.getElementById('errorLog').style.display = 'none';
        
        try {
            statusLog.innerText = "Pripravujem zdroje...";

            // A. GET SCREEN + SYSTEM AUDIO
            // Ak chceme system audio, musime dufat ze uzivatel zaskrtne checkbox v prehliadaci
            const displayConstraints = {
                video: { cursor: "always" },
                audio: state.sys // Toto povie prehliadacu, nech ponukne audio
            };

            stream = await navigator.mediaDevices.getDisplayMedia(displayConstraints);

            // Kontrola: Dal n√°m pou≈æ√≠vateƒæ naozaj zvuk syst√©mu?
            const hasSysAudio = stream.getAudioTracks().length > 0;
            if (state.sys && !hasSysAudio) {
                alert("‚ö†Ô∏è Upozornenie: Neza≈°krtli ste 'Zdieƒæa≈• zvuk syst√©mu' v okne prehliadaƒça. Nahr√°vka bude bez zvuku PC.");
            }

            // B. GET MICROPHONE (If requested)
            if (state.mic) {
                try {
                    micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true } });
                } catch (e) {
                    console.error("Mic error:", e);
                    alert("Nepodarilo sa z√≠ska≈• pr√≠stup k mikrof√≥nu.");
                    state.mic = false; // Disable mic if failed
                }
            }

            // C. MIX AUDIO (If multiple sources)
            let finalStream = new MediaStream();
            
            // Add Video Track
            stream.getVideoTracks().forEach(track => finalStream.addTrack(track));

            // Mix Audio Tracks
            if (state.mic || hasSysAudio) {
                audioContext = new AudioContext();
                mixedDest = audioContext.createMediaStreamDestination();

                if (hasSysAudio) {
                    const sysSource = audioContext.createMediaStreamSource(stream);
                    const sysGain = audioContext.createGain();
                    sysGain.gain.value = 1.0; // Volume PC
                    sysSource.connect(sysGain).connect(mixedDest);
                }

                if (state.mic && micStream) {
                    const micSource = audioContext.createMediaStreamSource(micStream);
                    const micGain = audioContext.createGain();
                    micGain.gain.value = 1.5; // Boost mic volume slightly
                    micSource.connect(micGain).connect(mixedDest);
                }

                // Add the mixed audio track to final stream
                mixedDest.stream.getAudioTracks().forEach(track => finalStream.addTrack(track));
            }

            // D. START RECORDER
            setupUIForRecording(finalStream);
            
            // Urƒçenie MIME typu
            let mimeType = "video/webm;codecs=vp9";
            if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = "video/webm";

            mediaRecorder = new MediaRecorder(finalStream, { mimeType });

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };

            mediaRecorder.onstop = processRecording;
            mediaRecorder.start(1000); // 1s chunks

            // Stop logic when user clicks "Stop Sharing" native browser button
            stream.getVideoTracks()[0].onended = stopRecording;

        } catch (err) {
            console.error(err);
            statusLog.innerText = "‚ùå Chyba spustenia.";
            alert("Chyba: " + err.message);
        }
    }

    function setupUIForRecording(stream) {
        previewVideo.srcObject = stream;
        previewVideo.classList.remove('hidden');
        placeholder.classList.add('hidden');
        
        btnStart.classList.add('hidden');
        btnStop.classList.remove('hidden');
        btnStop.classList.add('flex');
        
        recStatus.classList.remove('hidden');
        recStatus.classList.add('flex');
        
        // Timer
        startTime = Date.now();
        timerInterval = setInterval(updateTimer, 1000);
        
        // Disable controls
        document.getElementById('formatSelect').disabled = true;
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        
        // Stop all tracks
        if (stream) stream.getTracks().forEach(track => track.stop());
        if (micStream) micStream.getTracks().forEach(track => track.stop());
        if (audioContext) audioContext.close();

        clearInterval(timerInterval);
    }

    // --- 3. PROCESSING & CONVERSION ---

    async function processRecording() {
        // UI Reset
        recStatus.classList.add('hidden');
        btnStop.classList.add('hidden');
        statusLog.innerText = "Spracov√°vam video...";
        
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const format = document.getElementById('formatSelect').value;

        if (format === 'webm') {
            downloadBlob(blob, 'nahravka.webm');
            finishProcess();
            return;
        }

        // FFmpeg Conversion (MP4/GIF)
        try {
            statusLog.innerText = "‚è≥ Naƒç√≠tavam konvertor (FFmpeg)...";
            if (!ffmpeg) {
                ffmpeg = createFFmpeg({ corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js', log: true });
                await ffmpeg.load();
            }

            statusLog.innerText = `üîÑ Konvertujem na ${format.toUpperCase()}... Pros√≠m ƒçakajte.`;
            
            ffmpeg.FS('writeFile', 'input.webm', await fetchFile(blob));

            let args = [];
            if (format === 'mp4') {
                // Preset ultrafast pre r√Ωchlos≈•
                args = ['-i', 'input.webm', '-c:v', 'libx264', '-preset', 'ultrafast', '-c:a', 'aac', 'output.mp4'];
            } else if (format === 'gif') {
                args = ['-i', 'input.webm', '-vf', 'fps=10,scale=720:-1', 'output.gif'];
            }

            await ffmpeg.run(...args);

            const data = ffmpeg.FS('readFile', `output.${format}`);
            const outputBlob = new Blob([data.buffer], { type: format === 'mp4' ? 'video/mp4' : 'image/gif' });
            
            downloadBlob(outputBlob, `nahravka.${format}`);
            
            // Clean memory
            try { ffmpeg.FS('unlink', 'input.webm'); ffmpeg.FS('unlink', `output.${format}`); } catch(e){}

        } catch (e) {
            console.error(e);
            document.getElementById('errorLog').innerText = "Chyba konverzie: " + e.message + "\nS≈•ahujem origin√°l.";
            document.getElementById('errorLog').style.display = 'block';
            downloadBlob(blob, 'zachrana.webm');
        }

        finishProcess();
    }

    function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => window.URL.revokeObjectURL(url), 100);
    }

    function finishProcess() {
        statusLog.innerText = "‚úÖ Hotovo! S√∫bor stiahnut√Ω.";
        btnStart.classList.remove('hidden');
        previewVideo.classList.add('hidden');
        placeholder.classList.remove('hidden');
        document.getElementById('formatSelect').disabled = false;
        
        // Clear status after 3s
        setTimeout(() => statusLog.innerText = "Pripraven√© na nahr√°vanie.", 3000);
    }

</script>

</body>
</html>