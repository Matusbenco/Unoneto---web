<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inteligentn√Ω OCR Skener | OfficeSuite</title>
    
    <script src="coi-serviceworker.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8f9fa; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 350px 1fr; gap: 25px; }

        /* ƒΩAV√ù PANEL */
        .sidebar { background: white; padding: 20px; border-radius: 12px; height: calc(100vh - 40px); overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        
        .upload-area {
            border: 2px dashed #cbd5e0; padding: 30px 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; margin-bottom: 20px; background: #f7fafc;
        }
        .upload-area:hover { background: #ebf8ff; border-color: #3182ce; }

        .btn-action {
            padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; width: 100%; margin-bottom: 10px; font-size: 1rem;
        }
        .btn-start { background: #3182ce; }
        .btn-start:hover { background: #2b6cb0; }
        .btn-stop { background: #e53e3e; display: none; }
        .btn-summary { background: #805ad5; display: none; } 
        .btn-summary:hover { background: #6b46c1; }

        label { font-size: 0.85em; font-weight: bold; color: #4a5568; margin-bottom: 5px; display: block; }
        input[type="text"], select {
            width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #cbd5e0; box-sizing: border-box; font-family: inherit;
        }

        /* Checkbox pre preprocessing */
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-size: 0.9em; background: #edf2f7; padding: 10px; border-radius: 6px; }
        .checkbox-group input { margin: 0; width: auto; }

        /* PRAV√ù PANEL */
        .main-content { display: flex; flex-direction: column; gap: 20px; height: calc(100vh - 40px); }

        .summary-box {
            background: linear-gradient(135deg, #fff 0%, #f3f0ff 100%);
            border: 1px solid #d6bcfa; border-radius: 12px; padding: 20px;
            display: none; 
            box-shadow: 0 4px 10px rgba(128, 90, 213, 0.1);
        }
        .summary-title { font-weight: bold; color: #553c9a; margin-bottom: 10px; }

        .text-box {
            background: white; border-radius: 12px; padding: 20px; flex: 1; display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        textarea {
            flex: 1; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; resize: none;
            font-family: 'Courier New', monospace; font-size: 1em; line-height: 1.5; margin-top: 10px;
        }
        textarea:focus { outline: 2px solid #3182ce; border-color: transparent; }

        .progress-bar { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: #3182ce; width: 0%; transition: width 0.3s; }

        @media (max-width: 900px) { .container { grid-template-columns: 1fr; height: auto; } }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="sidebar">
            <h2 style="margin-top:0; color:#2d3748;">OCR & Zhrnutie</h2>
            
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div>üìÑ Klikni pre v√Ωber PDF/Foto</div>
                <input type="file" id="fileInput" accept="application/pdf, image/*" style="display:none">
            </div>

            <label>Jazyk dokumentu:</label>
            <select id="langSelect">
                <option value="slk">Slovenƒçina üá∏üá∞</option>
                <option value="eng">Angliƒçtina üá∫üá∏</option>
                <option value="ces">ƒåe≈°tina üá®üáø</option>
                <option value="deu">Nemƒçina üá©üá™</option>
            </select>

            <label>Strany na skenovanie:</label>
            <input type="text" id="pageRange" placeholder="napr. 1, 3-5 (pr√°zdne = v≈°etky)">

            <div class="checkbox-group">
                <input type="checkbox" id="preprocessCheck" checked>
                <label for="preprocessCheck" style="margin:0; font-weight:normal;">Vylep≈°i≈• kvalitu (pre bloƒçky)</label>
            </div>

            <button class="btn-action btn-start" id="btnProcess" disabled>‚ö° Spusti≈• skenovanie</button>
            <button class="btn-action btn-stop" id="btnStop">‚èπ Zastavi≈•</button>
            <button class="btn-action btn-summary" id="btnSummarize">üìù Vygenerova≈• zhrnutie</button>

            <div id="statusBox" style="margin-top:15px; font-size:0.9em; color:#718096;">
                <div id="statusLabel">Pripraven√©</div>
                <div class="progress-bar"><div class="progress-fill" id="progFill"></div></div>
            </div>

            <div id="previewContainer" style="margin-top:20px; overflow-y:auto; flex:1;"></div>
        </div>

        <div class="main-content">
            <div class="summary-box" id="summaryBox">
                <div class="summary-title">‚ú® Inteligentn√© zhrnutie</div>
                <div id="summaryText" style="color: #4a5568; line-height: 1.6;"></div>
            </div>

            <div class="text-box">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong>Rozpoznan√Ω text</strong>
                    <button onclick="copyText()" style="background:none; border:1px solid #cbd5e0; padding:5px 10px; border-radius:5px; cursor:pointer;">Kop√≠rova≈•</button>
                </div>
                <textarea id="outputText" placeholder="V√Ωsledok skenovania..."></textarea>
            </div>
        </div>

    </div>

<script>
    // === PREMENN√â ===
    const fileInput = document.getElementById('fileInput');
    const btnProcess = document.getElementById('btnProcess');
    const btnSummarize = document.getElementById('btnSummarize');
    const outputText = document.getElementById('outputText');
    const summaryBox = document.getElementById('summaryBox');
    const summaryText = document.getElementById('summaryText');
    const statusLabel = document.getElementById('statusLabel');
    const progFill = document.getElementById('progFill');
    const previewContainer = document.getElementById('previewContainer');
    const pageRangeInput = document.getElementById('pageRange');
    const preprocessCheck = document.getElementById('preprocessCheck');

    let pdfDoc = null;
    let worker = null;
    let fullRecognizedText = "";
    let isProcessing = false;

    // === 1. NAƒå√çTANIE S√öBORU ===
    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        resetUI();
        
        if (file.type === 'application/pdf') {
            await loadPDF(file);
            pageRangeInput.disabled = false;
        } else {
            await loadImage(file);
            pageRangeInput.disabled = true; // Pri obr√°zku sa strany nevyberaj√∫
            pageRangeInput.placeholder = "Nedostupn√© pre obr√°zky";
        }
        btnProcess.disabled = false;
        statusLabel.innerText = "S√∫bor pripraven√Ω.";
    });

    function resetUI() {
        previewContainer.innerHTML = '';
        outputText.value = '';
        fullRecognizedText = "";
        summaryBox.style.display = 'none';
        btnSummarize.style.display = 'none';
        progFill.style.width = "0%";
    }

    async function loadPDF(file) {
        const arrayBuffer = await file.arrayBuffer();
        pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
        renderThumb(1);
        statusLabel.innerText = `PDF: ${pdfDoc.numPages} str√°n`;
        pageRangeInput.placeholder = `Rozsah 1-${pdfDoc.numPages} (napr. 1, 3-5)`;
    }

    async function loadImage(file) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.style.maxWidth = '100%';
        img.style.borderRadius = '5px';
        previewContainer.appendChild(img);
        pdfDoc = null;
    }

    async function renderThumb(pageNum) {
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: 0.4 });
        const canvas = document.createElement('canvas');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
        previewContainer.appendChild(canvas);
    }

    // === 2. POMOCN√â FUNKCIE (Vylep≈°enie obrazu) ===
    
    // Funkcia na vyƒçistenie obrazu (Binariz√°cia / Kontrast)
    function preprocessImage(canvas) {
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        // Prahov√° hodnota pre ƒçiernu/bielu
        const threshold = 160; 

        for (let i = 0; i < data.length; i += 4) {
            // Prevod na odtiene sivej: (R + G + B) / 3
            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
            
            // Jednoduch√° binariz√°cia: Ak je svetl√Ω, daj bielu. Ak tmav√Ω, daj ƒçiernu.
            // Toto pom√°ha odstr√°ni≈• ≈°um z papiera √∫ƒçteniek.
            const color = avg > threshold ? 255 : 0;
            
            data[i] = color;     // R
            data[i + 1] = color; // G
            data[i + 2] = color; // B
        }
        ctx.putImageData(imageData, 0, 0);
        return canvas;
    }

    // Funkcia na parsovanie str√°n (napr. "1, 3-5")
    function getPagesToScan(totalPages) {
        const input = pageRangeInput.value.trim();
        if (!input) {
            // Ak je pr√°zdne, vr√°≈• v≈°etky strany
            return Array.from({length: totalPages}, (_, i) => i + 1);
        }

        const pages = new Set();
        const parts = input.split(',');

        parts.forEach(part => {
            if (part.includes('-')) {
                const [start, end] = part.split('-').map(Number);
                if (!isNaN(start) && !isNaN(end)) {
                    for (let i = start; i <= end; i++) {
                        if (i >= 1 && i <= totalPages) pages.add(i);
                    }
                }
            } else {
                const num = Number(part);
                if (!isNaN(num) && num >= 1 && num <= totalPages) {
                    pages.add(num);
                }
            }
        });

        return Array.from(pages).sort((a, b) => a - b);
    }

    // === 3. OCR PROCES ===
    btnProcess.addEventListener('click', async () => {
        isProcessing = true;
        btnProcess.style.display = 'none';
        document.getElementById('btnStop').style.display = 'block';
        
        const lang = document.getElementById('langSelect').value;
        const doPreprocess = preprocessCheck.checked;
        fullRecognizedText = "";

        try {
            worker = Tesseract.createWorker({
                logger: m => {
                    if (m.status === 'recognizing text') {
                        progFill.style.width = (m.progress * 100) + "%";
                        statusLabel.innerText = `ƒå√≠tam text: ${Math.round(m.progress * 100)}%`;
                    } else {
                        statusLabel.innerText = m.status;
                    }
                }
            });

            await worker.load();
            await worker.loadLanguage(lang);
            await worker.initialize(lang);

            if (pdfDoc) {
                // Z√≠skanie zoznamu str√°n na spracovanie
                const pagesToScan = getPagesToScan(pdfDoc.numPages);
                
                if (pagesToScan.length === 0) {
                    alert("Zadali ste neplatn√Ω rozsah str√°n.");
                    throw new Error("Neplatn√© strany");
                }

                for (let i = 0; i < pagesToScan.length; i++) {
                    if (!isProcessing) break;
                    
                    const pageNum = pagesToScan[i];
                    statusLabel.innerText = `Sprac√∫vam stranu ${pageNum} (${i+1}/${pagesToScan.length})...`;
                    
                    const page = await pdfDoc.getPage(pageNum);
                    // Vy≈°≈°ia scale = lep≈°ia kvalita pre OCR (bloƒçky potrebuj√∫ aspo≈à 2.5)
                    const viewport = page.getViewport({ scale: 2.5 });
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                    
                    // Vylep≈°enie kvality obrazu pred ƒç√≠tan√≠m
                    if (doPreprocess) {
                        preprocessImage(canvas);
                    }

                    const { data: { text } } = await worker.recognize(canvas);
                    fullRecognizedText += `--- STRANA ${pageNum} ---\n${text}\n\n`;
                    outputText.value = fullRecognizedText;
                    outputText.scrollTop = outputText.scrollHeight;
                }
            } else {
                // Spracovanie obr√°zka
                // Pre obr√°zky mus√≠me najprv vytvori≈• Canvas, aby sme ho mohli upravi≈•
                const img = previewContainer.querySelector('img');
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                if (doPreprocess) {
                    statusLabel.innerText = "Vylep≈°ujem kvalitu obrazu...";
                    preprocessImage(canvas);
                }

                statusLabel.innerText = "ƒå√≠tam text z obr√°zka...";
                const { data: { text } } = await worker.recognize(canvas);
                fullRecognizedText = text;
                outputText.value = text;
            }

            statusLabel.innerText = "‚úÖ Hotovo!";
            await worker.terminate();
            
            document.getElementById('btnStop').style.display = 'none';
            btnProcess.style.display = 'block';
            btnSummarize.style.display = 'block';

        } catch (err) {
            console.error(err);
            if (isProcessing) statusLabel.innerText = "Chyba: " + err.message;
        }
    });

    document.getElementById('btnStop').addEventListener('click', async () => {
        isProcessing = false;
        if (worker) await worker.terminate();
        statusLabel.innerText = "Zastaven√©.";
        document.getElementById('btnStop').style.display = 'none';
        btnProcess.style.display = 'block';
    });

    // === 4. ZHRNUTIE ===
    btnSummarize.addEventListener('click', () => {
        const text = fullRecognizedText;
        if (!text || text.length < 30) {
            alert("Text je pr√≠li≈° kr√°tky na zhrnutie.");
            return;
        }

        const cleanText = text.replace(/\s+/g, ' ').trim();
        const sentences = cleanText.match(/[^.!?]+[.!?]+(?=\s|$)/g) || [cleanText];

        if (sentences.length < 3) {
            summaryText.innerHTML = cleanText;
            summaryBox.style.display = 'block';
            return;
        }

        const wordFreq = {};
        const stopWords = ["a","v","s","z","na","do","je","to","o","pre","po","ako","tak","ale","≈æe","sa","si","aj","u≈æ","pri","od","ten","t√°","s√∫","bude","by","ƒço","kde","kto","kedy","ty","ja","on","my","vy","oni", "eur", "dph", "celkom", "suma"];
        
        const words = cleanText.toLowerCase().split(/[\s,.]+/);
        words.forEach(w => {
            if (w.length > 3 && !stopWords.includes(w)) wordFreq[w] = (wordFreq[w] || 0) + 1;
        });

        const sentenceScores = sentences.map((s, index) => {
            let score = 0;
            const sWords = s.toLowerCase().split(/[\s,.]+/);
            sWords.forEach(w => { if (wordFreq[w]) score += wordFreq[w]; });
            return { index, text: s, score: score / (sWords.length || 1) };
        });

        const topSentences = sentenceScores.sort((a, b) => b.score - a.score).slice(0, 5).sort((a, b) => a.index - b.index).map(s => s.text);

        summaryText.innerHTML = `<ul>${topSentences.map(s => `<li>${s.trim()}</li>`).join('')}</ul>`;
        summaryBox.style.display = 'block';
        summaryBox.scrollIntoView({behavior: "smooth"});
    });

    function copyText() {
        outputText.select();
        document.execCommand('copy');
    }
</script>

</body>
</html>